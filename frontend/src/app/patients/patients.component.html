
<app-navbar/>
<div class="patient-container">
  <h2>Patients</h2>

  @if (role === 'Admin' || role === 'Staff') {
    <div class="add-patient-form">
      <h3>Add Patient</h3>
      <form [formGroup]="addPatientForm" (ngSubmit)="addPatient()">
        <input formControlName="fullName" placeholder="Full Name" />
        @if (addPatientForm.controls['fullName'].touched && addPatientForm.controls['fullName'].invalid) {
          <div class="error">Full Name is required.</div>
        }
        <input formControlName="email" placeholder="Email" type="email" />
        @if (addPatientForm.controls['email'].touched && addPatientForm.controls['email'].invalid) {
          <div class="error">
            @if (addPatientForm.controls['email'].errors?.['required']) { Email is required. }
            @if (addPatientForm.controls['email'].errors?.['email']) { Invalid email format. }
          </div>
        }
        <input formControlName="phone" placeholder="Phone" />
        @if (addPatientForm.controls['phone'].touched && addPatientForm.controls['phone'].invalid) {
          <div class="error">Phone is required.</div>
        }
        <input formControlName="dateOfBirth" placeholder="Date of Birth" type="date" />
        @if (addPatientForm.controls['dateOfBirth'].touched && addPatientForm.controls['dateOfBirth'].invalid) {
          <div class="error">Date of Birth is required.</div>
        }
        <input formControlName="gender" placeholder="Gender" />
        @if (addPatientForm.controls['gender'].touched && addPatientForm.controls['gender'].invalid) {
          <div class="error">Gender is required.</div>
        }
        <input formControlName="address" placeholder="Address" />
        @if (addPatientForm.controls['address'].touched && addPatientForm.controls['address'].invalid) {
          <div class="error">Address is required.</div>
        }
        <button type="submit" [disabled]="addPatientLoading || addPatientForm.invalid">
          @if (addPatientLoading) { Adding... } @else { Add Patient }
        </button>
        <!-- Success/error messages are now shown globally via MessageService -->
      </form>

      @if (showDuplicateWarning) {
        <div class="duplicate-warning">
          <strong>Potential duplicate(s) found:</strong>
          <ul>
            @for (match of duplicateMatches; track match) {
              <li>
                Name: {{ match.fullName }}, Email: {{ match.email }}, Phone: {{ match.phone }}
              </li>
            }
          </ul>
          <div>
            <button (click)="confirmAddPatient()">Proceed Anyway</button>
            <button (click)="cancelAddPatient()">Cancel</button>
          </div>
        </div>
      }
    </div>
  } @else if (role === 'Clinician') {
    <div class="info" style="margin-bottom:1rem;">
      As a Clinician, you can only view/search patients. Adding new patients is not permitted.
    </div>
  }

  <div class="controls">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()" style="display: flex; gap: 0.5rem; align-items: center;">
      <input type="text" placeholder="Search by name/email/phone..." formControlName="query" />
      <button type="submit">Search</button>
    </form>
  </div>

  @if (loading) {
    <div>Loading...</div>
  }
  @if (error) {
    <div class="error">{{ error }}</div>
  }

  @if (patients.length > 0) {
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Date of Birth</th>
          <th>Gender</th>
          <th>Address</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody>
        @for (patient of patients; track patient) {
          <tr>
            <td>{{ patient.fullName }}</td>
            <td>{{ patient.email }}</td>
            <td>{{ patient.phone }}</td>
            <td>{{ patient.dateOfBirth | date }}</td>
            <td>{{ patient.gender }}</td>
            <td>{{ patient.address }}</td>
            <td>{{ patient.createdAt | date:'short' }}</td>
          </tr>
        }
      </tbody>
    </table>
  }

  @if (totalCount > pageSize) {
    <div class="pagination">
      <button (click)="changePage(page - 1)" [disabled]="page === 1">Prev</button>
      <span>Page {{ page }} of {{ totalPages }}</span>
      <button (click)="changePage(page + 1)" [disabled]="page >= totalPages">Next</button>
    </div>
  }
</div>
